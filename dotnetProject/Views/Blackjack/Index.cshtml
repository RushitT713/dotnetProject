@model dotnetProject.Models.BlackjackGame
@{
    ViewData["Title"] = "Blackjack";
}
<link rel="stylesheet" href="~/css/animation.css" />
<link rel="stylesheet" href="~/css/site.css" />
<style>
    /* === BLACKJACK REDESIGN (NEW CSS) === */

    /* 1. Make the container fill the screen (minus navbar) */
    .blackjack-container.blackjack-page-container {
        max-width: none;
        width: 100%;
        /* 100px is the navbar height from your site.css */
        height: calc(100vh - 100px);
        margin: 0;
        border-radius: 0;
        border: none;
        background: transparent; /* Body already has the bg */
        box-shadow: none;
        /* Main flex layout: Header on top, Body fills the rest */
        display: flex;
        flex-direction: column;
        padding: 1rem 1.5rem;
        gap: 1rem;
    }

    /* 2. Style the new persistent header */
    .blackjack-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0; /* Don't shrink header */
    }

    /* 3. Tweak existing header elements for the new layout */
    .blackjack-page-container h2 {
        margin-bottom: 0; /* Remove old margin */
        font-size: 2.25rem;
    }

    .blackjack-page-container .balance-display {
        margin-bottom: 0; /* Remove old margin */
        padding: 1rem 1.5rem;
        /* background: var(--bg-elevated); */ /* Already set */
    }

    /* 4. Style the new body wrapper */
    .blackjack-body {
        flex-grow: 1; /* This is key: it fills the remaining height */
        position: relative;
        display: flex;
        width: 100%;
    }

        /* 5. Style the *toggled* content divs */
        .blackjack-body #betting-phase,
        .blackjack-body #game-table {
            /* This is the magic:
                          - We default to 'display: flex'
                          - The JS will set 'display: none' to hide
                          - The JS will set 'display: block' to show,
                            BUT our script fix overrides it back to 'flex'
                        */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            box-shadow: 0 8px 30px var(--shadow);
        }

        /* 6. Re-style the *insides* of #betting-phase */
        .blackjack-body #betting-phase {
            justify-content: center;
            gap: 1.5rem;
        }

            .blackjack-body #betting-phase h4 {
                margin: 0;
            }

        .blackjack-body .chips {
            margin: 0;
        }

        .blackjack-body .bet-display {
            margin: 0;
        }

        /* 7. Re-style the *insides* of #game-table */
        .blackjack-body #game-table {
            justify-content: space-between; /* Space out hands, result, actions */
            gap: 1rem;
        }

    .game-hands-area {
        display: flex;
        justify-content: space-around;
        width: 100%;
        gap: 2rem;
    }

    .hand-container {
        flex: 1;
        min-width: 300px;
    }

        .hand-container h5 {
            margin-bottom: 1rem;
        }

    /* Make card areas larger */
    .blackjack-body .cards {
        min-height: 140px;
        padding: 1.5rem;
        gap: 1rem; /* More space between cards */
        /* Styles from site.css are kept */
    }

    /* Make cards larger */
    .card-item {
        width: 80px;
        height: 120px;
        font-size: 1.8rem;
        border-radius: 10px;
    }

    /* Style result message */
    #result-message {
        padding: 1rem;
        min-height: 0; /* Remove old min-height */
        margin: 0;
        background: transparent; /* Make it float */
        text-align: center;
    }

    /* Style action area */
    .game-actions-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .player-actions {
        margin: 0; /* Remove old margin */
        gap: 2rem;
    }

        .player-actions .btn {
            width: 100px; /* Slightly smaller for balance */
            height: 100px;
        }


    /* === EXISTING CARD FLIP CSS (Moved here) === */

    .flip-card {
        width: 100%;
        height: 100%;
        perspective: 600px;
    }

    .flip-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        transition: transform 0.6s ease;
    }

    .flip-front, .flip-back {
        position: absolute;
        backface-visibility: hidden;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px; /* Match new card-item radius */
        font-size: 1.8rem; /* Match new card-item font size */
        font-weight: 700;
    }

    .flip-front {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 3rem; /* Make card back icon bigger */
    }

    .flip-back {
        background: white;
        color: #000;
        transform: rotateY(180deg);
    }

    .flip-inner.reveal {
        transform: rotateY(180deg);
    }

    .card-flip-container {
        width: 80px; /* Match new card-item size */
        height: 120px; /* Match new card-item size */
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }

    /* Make card suit on back match new card-item size */
    .flip-back.red-suit {
        color: var(--red-suit);
    }

    .flip-back.black-suit {
        color: var(--black-suit);
    }

</style>
<div class="blackjack-container fade-in blackjack-page-container">

    <div class="blackjack-header">
        <h2>Blackjack</h2>
        <div class="balance-display">
            <strong>Balance</strong>
            <div>
                <span style="font-size: 1.5rem;">₹</span><span id="balance">@Model.PlayerBalance</span>
            </div>
        </div>
    </div>

    <div class="blackjack-body">

        <div id="betting-phase">
            <h4 style="text-align: center; color: var(--text-secondary); margin: 0 0 1.5rem; font-size: 1.1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Place Your Bet</h4>

            <div class="chips">
                <button class="btn-chip" data-value="5"><span>₹5</span></button>
                <button class="btn-chip" data-value="10"><span>₹10</span></button>
                <button class="btn-chip" data-value="25"><span>₹25</span></button>
                <button class="btn-chip" data-value="100"><span>₹100</span></button>
                <button class="btn-chip" data-value="500"><span>₹500</span></button>
                <button class="btn-chip" id="btn-all-in"><span>ALL IN</span></button>
            </div>

            <div class="bet-display">
                <strong>Current Bet</strong>
                <div>
                    <span style="font-size: 1.2rem;">₹</span><span id="current-bet">0</span>
                </div>
            </div>

            <div class="bet-actions">
                <button id="clear-bet" class="btn btn-secondary" style="min-width: 140px;">
                    Clear Bet
                </button>
                <button id="ready-bet" class="btn btn-primary" style="min-width: 140px;">Deal Cards</button>
            </div>
        </div>

        <div id="game-table" style="display:none;">

            <div class="game-hands-area">
                <div class="hand-container">
                    <h5 style="text-align: center; color: var(--text-secondary); font-size: 1rem; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px;">
                        Dealer's Hand
                        <span style="color: var(--primary); font-size: 1.3rem; margin-left: 0.5rem; font-weight: 700;" id="dealer-score">?</span>
                    </h5>
                    <div id="dealer-cards" class="cards"></div>
                </div>

                <div class="hand-container">
                    <h5 style="text-align: center; color: var(--text-secondary); font-size: 1rem; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px;">
                        Your Hand
                        <span style="color: var(--primary); font-size: 1.3rem; margin-left: 0.5rem; font-weight: 700;" id="player-score">0</span>
                    </h5>
                    <div id="player-cards" class="cards"></div>
                </div>
            </div>

            <div id="result-message"></div>

            <div class="game-actions-area">
                <div class="player-actions">
                    <button id="btn-hit" class="btn btn-warning">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 2rem;">👊</span>
                            <span>HIT</span>
                        </div>
                    </button>
                    <button id="btn-stand" class="btn btn-success">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 2rem;">✋</span>
                            <span>STAND</span>
                        </div>
                    </button>
                </div>

                <div class="mt-3 text-center">
                    <button id="btn-new-round" class="btn btn-primary" style="display:none; min-width: 200px; padding: 1rem 2rem;">
                        New Round
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        function renderCards(containerId, cards, faceDownCount = 0) {
            const div = document.getElementById(containerId);
            div.innerHTML = '';

            cards.forEach((c, i) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card-item';

                if (faceDownCount > 0 && i >= cards.length - faceDownCount) {
                    cardEl.innerHTML = `
                        <div class="flip-card">
                            <div class="flip-inner">
                                <div class="flip-front">🂠</div>
                                <div class="flip-back">${c}</div>
                            </div>
                        </div>`;
                    cardEl.classList.add('card-flip-container');
                } else {
                    cardEl.textContent = c;
                    const suit = c.slice(-1);
                    if (suit === '♥' || suit === '♦') {
                        cardEl.classList.add('red-suit');
                    } else {
                        cardEl.classList.add('black-suit');
                    }
                }

                div.appendChild(cardEl);
                setTimeout(() => cardEl.classList.add('card-dealt'), i * 100);
            });
        }

        let currentBet = 0;
        const balanceEl = document.getElementById('balance');
        const betEl = document.getElementById('current-bet');

        document.querySelectorAll('.btn-chip[data-value]').forEach(chip => {
            chip.addEventListener('click', () => {
                const v = parseInt(chip.dataset.value, 10);
                const bal = parseInt(balanceEl.textContent, 10);

                if (currentBet + v > bal) {
                    showNotification('Insufficient balance!', 'error');
                    currentBet = bal;
                } else {
                    currentBet += v;
                }
                betEl.textContent = currentBet;
            });
        });
        document.getElementById('btn-all-in').addEventListener('click', () => {
            const bal = parseInt(balanceEl.textContent, 10);
            const oldBet = currentBet;
            currentBet = bal;
            betEl.textContent = currentBet;
            animateValue(betEl, oldBet, currentBet, 500);
        });
        document.getElementById('clear-bet').addEventListener('click', () => {
            animateValue(betEl, currentBet, 0, 300);
            currentBet = 0;
        });

         document.getElementById('ready-bet').addEventListener('click', async () => {
            const bal = parseInt(balanceEl.textContent, 10);
            if (currentBet <= 0) {
                return showNotification('Please select a bet amount', 'error');
            }
            if (currentBet > bal) {
                 return showNotification('Insufficient balance! Please adjust your bet.', 'error');
            }

            const form = new FormData();
            form.append('amount', currentBet);
            const res = await fetch('/Blackjack/PlaceBet', { method: 'POST', body: form });
            const data = await res.json();

            if (data.error) {
                showNotification(data.error, 'error');
                return;
            }

             document.getElementById('betting-phase').style.display = 'none';
             document.getElementById('game-table').style.display = 'flex'; // Use flex to match new CSS

            renderCards('player-cards', data.playerHand, 0);
            document.getElementById('player-score').textContent = data.playerScore;

            animateValue(balanceEl, bal, data.balance, 500);

            if (data.isGameOver) {
                renderCards('dealer-cards', data.dealerHand, 0);
                document.getElementById('dealer-score').textContent = data.dealerScore;
                showResult(data.result);
                endRound();
            } else {
                renderCards('dealer-cards', data.dealerHand, 1);
                document.getElementById('dealer-score').textContent = '?';
            }
        });

        document.getElementById('btn-hit').addEventListener('click', async () => {
            const res = await fetch('/Blackjack/Hit', { method: 'POST' });
            const data = await res.json();

            renderCards('player-cards', data.playerHand, 0);
            document.getElementById('player-score').textContent = data.playerScore;

            if (data.isBust) {
                stand();
            }
        });

        const standButton = document.getElementById('btn-stand');
        standButton.addEventListener('click', stand);

        async function stand() {
            document.getElementById('btn-hit').disabled = true;
            standButton.disabled = true;

            const res = await fetch('/Blackjack/Stand', { method: 'POST' });
            const data = await res.json();

            renderCards('dealer-cards', data.dealerHand, 0);
            document.querySelectorAll('#dealer-cards .flip-inner').forEach(inner => {
                setTimeout(() => inner.classList.add('reveal'), 200);
            });

            setTimeout(() => {
                document.getElementById('dealer-score').textContent = data.dealerScore;
                showResult(data.result);

                const oldBalance = parseInt(balanceEl.textContent);
                animateValue(balanceEl, oldBalance, data.balance, 800);
                endRound();
            }, 600);
        }

        function endRound() {
            document.getElementById('btn-hit').disabled = true;
            document.getElementById('btn-stand').disabled = true;

            // Grab the button element
            const newRoundButton = document.getElementById('btn-new-round');

            // Show the button
            newRoundButton.style.display = 'inline-block';

            // --- ADD THIS LINE ---
            // This will highlight the button and allow keyboard activation
            newRoundButton.focus();
            // --------------------
        }

        function showResult(result) {
            let resultColor = 'var(--text-secondary)';
            let resultIcon = '🤝';
            if (result.includes('win') || result.includes('Win') || result.includes('Blackjack!')) {
                resultColor = 'var(--success)';
                resultIcon = '🎉';
            } else if (result.includes('lose') || result.includes('Lose') || result.includes('Bust')) {
                resultColor = 'var(--danger)';
                resultIcon = '💔';
            }

            document.getElementById('result-message').innerHTML = `
                <div style="color: ${resultColor}; font-size: 1.8rem; animation: fadeIn 0.5s ease;">
                    ${resultIcon} ${result}
                </div>`;
        }

        document.getElementById('btn-new-round').addEventListener('click', () => {
            currentBet = 0;
            document.getElementById('current-bet').textContent = '0';
            document.getElementById('game-table').style.display = 'none';
            document.getElementById('betting-phase').style.display = 'flex'; // Use flex
            document.getElementById('dealer-cards').innerHTML = '';
            document.getElementById('player-cards').innerHTML = '';
            document.getElementById('result-message').innerHTML = '';
            document.getElementById('player-score').textContent = '0';
            document.getElementById('dealer-score').textContent = '?';
            document.getElementById('btn-hit').disabled = false;
            document.getElementById('btn-stand').disabled = false;
            document.getElementById('btn-new-round').style.display = 'none';
        });

        function animateValue(element, start, end, duration) {
            if (start === end) {
                element.textContent = end;
                return;
            }
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = end;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'error' ? 'var(--danger)' : 'var(--success)'};
                color: white;
                border-radius: 12px;
                font-weight: 600;
                z-index: 9999;
                animation: fadeIn 0.3s ease;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // **IMPORTANT** When the JS runs, it will now set
        // #game-table and #betting-phase to 'display: block'.
        // We need to use 'display: flex' for the new layout.
        // This small script overrides the inline 'display: block'
        // set by the original JS.
        document.addEventListener('DOMContentLoaded', () => {
             // Fix initial state for betting phase
            const bettingPhase = document.getElementById('betting-phase');
            if (bettingPhase.style.display !== 'none') {
                bettingPhase.style.display = 'flex';
            }

            // Fix for 'ready-bet' click
            const readyBetBtn = document.getElementById('ready-bet');
            readyBetBtn.addEventListener('click', () => {
                // The original script will set #game-table to 'block'.
                // We run this just after to correct it to 'flex'.
                setTimeout(() => {
                    const gameTable = document.getElementById('game-table');
                    if (gameTable.style.display === 'block') {
                         gameTable.style.display = 'flex';
                    }
                }, 0);
            }, true); // Use capture phase to be safe, though not strictly needed

            // Fix for 'new-round' click
            const newRoundBtn = document.getElementById('btn-new-round');
            newRoundBtn.addEventListener('click', () => {
                setTimeout(() => {
                    const bettingPhase = document.getElementById('betting-phase');
                    if (bettingPhase.style.display === 'block') {
                        bettingPhase.style.display = 'flex';
                    }
                }, 0);
            });
        });

    </script>
}